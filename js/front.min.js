YUI().use("node","event","io","node-scroll-info","handlebars","json-parse","jsonp","jsonp-url","gallery-idletimer",function(Y){"use strict";var body=Y.one("body"),container=Y.one("#a"),query=Y.one(".query"),loadMoreButton=Y.one(".pure-button.loading"),datasourceURLs=getDiscoveryDatasources(body.getData()),searchString="*:*",transactions=[],fold=200,source=Y.one("#list-template").getHTML(),template=Y.Handlebars.compile(source);function onFailure(){Y.log("onFailure")}function getDiscoveryDatasources(datasources){var sources=[];Y.Object.each(datasources,function(element,index){if(index.match(/discovery-/)){sources.push(element)}});return sources}function onTimeout(){onFailure()}function onClick(e){e.preventDefault();onScroll()}function onSubmit(e){e.preventDefault();var currentTarget=e.currentTarget,value=Y.one(".pure-input");location.href=currentTarget.get("action")+"/"+value.get("value")}function onNotNow(e){e.preventDefault();alert("Sorry, not working at this moment")}function onScroll(){var numfound=0,start=0,docslength=0,next=0,sourceIndex=0,sourceLength=1,href;if(body.hasClass("io-done"))return;sourceIndex=parseInt(container.getAttribute("data-sourceIndex"),10);sourceLength=parseInt(container.getAttribute("data-sourceLength"),10);numfound=parseInt(container.getAttribute("data-numfound"),10);start=parseInt(container.getAttribute("data-start"),10);docslength=parseInt(container.getAttribute("data-docslength"),10);next=start+docslength;if(next<=numfound){href=datasourceURLs[sourceIndex]+"&start="+next;if(Y.Array.indexOf(transactions,href)<0&&!body.hasClass("io-loading")){if(body.scrollInfo.getScrollInfo().atBottom||Y.IdleTimer.isIdle()&&pager.get("region").top-fold<body.get("winHeight")){body.addClass("io-loading");Y.jsonp(href,{on:{success:onSuccess,failure:onFailure,timeout:onTimeout},args:[sourceIndex,sourceLength],timeout:3e3})}}}}function onSuccess(response,index,length){try{var numfound=parseInt(response.response.numFound,10),start=parseInt(response.response.start,10),docslength=parseInt(response.response.docs.length,10);response.response.docs.forEach(function(element,index,array){element.app=element.ss_collection_identifier;element.thumbHref=element.teaser;element.title=element.sm_field_title;element.identifier=element.ss_identifer;element.author=element.sm_field_author;element.description=element.teaser;element.thumbHref=element.ss_representative_image});transactions.push(this.url);container.setAttribute("data-numFound",numfound);container.setAttribute("data-start",start);container.setAttribute("data-docsLength",docslength);container.append(template({items:response.response.docs}));if(start+docslength===numfound&&index+1===length){body.addClass("io-done")}else if(start+docslength===numfound&&index+1<length){container.setAttribute("data-sourceIndex",index+1);container.setAttribute("data-numFound",0);container.setAttribute("data-start",0);container.setAttribute("data-docsLength",0)}body.removeClass("io-loading");loadMoreButton.removeClass("pure-button-disabled")}catch(e){Y.log("error")}}Y.IdleTimer.subscribe("idle",onScroll);Y.IdleTimer.start(5e3);body.plug(Y.Plugin.ScrollInfo,{scrollMargin:fold});body.scrollInfo.on({scroll:onScroll});if(datasourceURLs[0]){container.setAttribute("data-sourceLength",datasourceURLs.length);container.setAttribute("data-sourceIndex",0);Y.jsonp(datasourceURLs[0],{on:{success:onSuccess,failure:onFailure,timeout:onTimeout},args:[0,datasourceURLs.length],timeout:3e3})}loadMoreButton.on("click",onClick);body.delegate("submit",onNotNow,"form")});