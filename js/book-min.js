YUI.add("crossframe",function(Y){var _openerObject,_retryCounter=0,PATTERN=/top|parent|opener|frames\[(?:(?:['"][a-zA-Z\d-_]*['"])|\d+)\]/,DEFAULT_EVENT="crossframe:message",MODULE_ID="CrossFrame",RETRY_AMOUNT=10,SUCCESS_MESSAGE="__SUCCESS_CALLBACK__",_onMessage,_bindOpener,_init,_messageCallbackAdapter,_postMessageByOpener,addPublisher,appendFrame,postMessage,set,setOpener,messageReceiveAdapter,messageReceiveEvent;_onMessage=function(e,isOpener){var evt={},callback=null,publisher=null,data=Y.QueryString.parse(e.data),tid=data.tid,message=data.message,eventType=data.eventType,target=data.target,sourceUrl=data.url;if(decodeURIComponent(message)===SUCCESS_MESSAGE){try{window[tid](data)}catch(e2){Y.log(e2.message,"error",MODULE_ID)}return}evt={type:eventType,data:e.data,origin:e.origin,lastEventId:e.lastEventId,source:e.source,ports:e.ports};callback=function(o){var i,query,message;query=[];for(i in o){if(o.hasOwnProperty(i)){if(i==="url"||i==="target"||i==="tid"||i==="message"){continue}o[i]=o[i].toString();query.push(i+"="+encodeURIComponent(o[i]))}}url=["url="+encodeURIComponent(sourceUrl),"target="+encodeURIComponent(target),"tid="+tid,"message="+encodeURIComponent(Y.CrossFrame.SUCCESS_MESSAGE)].join("&");if(isOpener){window.opener.messageCallbackAdapter(url+"&"+query.join("&"))}else{e.source.postMessage(url+"&"+query.join("&"),"*")}};if(eventType){publisher=addPublisher(eventType);publisher.fire(eventType,evt,data,callback)}messageReceiveEvent.fire(DEFAULT_EVENT,evt,data,callback)};_bindOpener=function(){Y.log("_bindOpener() is executed.","info",MODULE_ID);if(typeof window.opener==="undefined"||typeof window.opener.messageCallbackAdapter==="undefined"){Y.later(100,null,arguments.callee);return}window.opener.messageReceiveAdapter=messageReceiveAdapter};_init=function(){Y.log("_init(): is executed","info",MODULE_ID);if(typeof window.addEventListener!=="undefined"){window.addEventListener("message",_onMessage,false)}else if(typeof window.attachEvent!=="undefined"&&Y.UA.ie>=8){window.attachEvent("onmessage",_onMessage)}else{Y.log("_init(): This browser doesn't support onmessage event.","info",MODULE_ID)}};_messageCallbackAdapter=function(dataString){var data=Y.QueryString.parse(dataString);if(decodeURIComponent(data.message)!==SUCCESS_MESSAGE){return}window[data.tid](data)};_postMessageByOpener=function(dataString,proxyUrl){if(typeof _openerObject.messageReceiveAdapter==="undefined"){_retryCounter++;if(_retryCounter>RETRY_AMOUNT){Y.log("_postMessageByOpener() - It fails because target frame have no window.opener.messageReceiveAdapter.","info",MODULE_ID);appendFrame(proxyUrl+"#"+dataString);return}Y.later(100,null,arguments.callee,[dataString,proxyUrl]);return}_openerObject.messageReceiveAdapter(dataString,window);_retryCounter=0};addPublisher=function(eventType,eventName){Y.log("addPublisher() is executed.","info",MODULE_ID);var publisher=new Y.EventTarget;eventName=eventName||"";publisher.name=eventName;publisher.publish(eventType,{broadcast:2,emitFacade:true});return publisher};appendFrame=function(url){Y.log("appendFrame(): is executed","info",MODULE_ID);var iframeEl,iframeNode,iframeLoadHandle;iframeEl=document.createElement("iframe");iframeEl.style.position="absolute";iframeEl.style.top="0";iframeEl.style.left="0";iframeEl.style.visibility="hidden";iframeEl.style.width="0";iframeEl.style.height="0";document.body.appendChild(iframeEl);iframeNode=Y.one(iframeEl);iframeLoadHandle=iframeNode.on("load",function(){Y.detach(iframeLoadHandle);Y.later(1e3,null,function(){document.body.removeChild(iframeEl)})});iframeEl.src=url;document.body.appendChild(iframeEl)};postMessage=function(target,message,config){Y.log("postMessage(): is executed","info",MODULE_ID);var pattern=/frames\[['"](^].)['"]\]/gi;if(!target||!message){Y.log("You have to provide both target and message arguments.","error",MODULE_ID);return}if(!Y.Lang.isObject(target)&&!PATTERN.test(target)){Y.log("Frame string format error!\n"+target,"error",MODULE_ID);return}config=config||{};config.callback=config.callback||function(){};config.proxy=config.proxy||null;config.reverseProxy=config.reverseProxy||null;config.eventType=config.eventType||null;config.useProxy=config.useProxy===true||false;if(typeof message==="Object"){message=Y.JSON.stringify(message)}var dataString,frameString,isSupport,openerObject,tId,origin,ports;tId=parseInt((new Date).getTime(),10);try{origin=location.host.toString()}catch(e){origin=""}try{ports=location.port.toString()}catch(e2){ports=""}dataString=["tid="+tId,"eventType="+encodeURIComponent(config.eventType),"target="+encodeURIComponent(target),"message="+encodeURIComponent(message),"domain="+encodeURIComponent(document.domain),"url="+encodeURIComponent(location.href),"reverseProxy="+encodeURIComponent(config.reverseProxy),"useProxy="+config.useProxy,"source="+encodeURIComponent(window.name),"origin="+origin,"ports="+ports].join("&");window[tId]=function(o){delete o.message;delete o.target;delete o.tid;delete o.url;config.callback(o)};isSupport=Y.UA.ie&&Y.UA.ie<8?false:true;isSupport=typeof window.postMessage==="undefined"?false:isSupport;isSupport=target==="opener"&&Y.UA.ie?false:isSupport;isSupport=config.useProxy?false:isSupport;switch(isSupport){case false:if(target!=="opener"&&!config.useProxy){Y.log("postMessage() - You are using opener hack approach.","info",MODULE_ID);if(!_openerObject){_openerObject={};_openerObject.messageCallbackAdapter=_messageCallbackAdapter;target=eval(target);target.opener=_openerObject}_postMessageByOpener(dataString,config.proxy);return}if(!config.proxy){Y.log("You can't use Y.CrossFrame.postMessage in this legend browser without providing proxy URL","error",MODULE_ID);return}Y.log("postMessage() - You are using iframe in iframe approach.","info",MODULE_ID);appendFrame(config.proxy+"#"+dataString);break;case true:try{target=eval(target)}catch(e){Y.log(e.message,"error",MODULE_ID);return}target.postMessage(dataString,"*");break}return tId};set=function(key,value){switch(key){case"receiver":if(typeof window.postMessage!=="undefined"){return}if(value===true){_bindOpener()}break}};setOpener=function(targetFrameName){if(typeof window.postMessage!=="undefined"){return}if(window.name.toString()===targetFrameName){_bindOpener()}else{var iframeEl=document.getElementByName(targetFrameName);if(!iframeEl){Y.error("The target iframe doesn't exist")}_openerObject={};_openerObject.messageCallbackAdapter=_messageCallbackAdapter;iframeEl.contentWindow.opener=_openerObject}};messageReceiveAdapter=function(dataString,sourceWin){Y.log("messageReceiveAdapter() is executed.","info",MODULE_ID);var evt={},data=Y.QueryString.parse(dataString);evt={type:data.eventType,data:dataString,origin:data.origin,lastEventId:data.tid,source:sourceWin,ports:data.ports};_onMessage(evt,sourceWin)};messageReceiveEvent=function(){Y.log("messageReceiveEvent(): is executed","info",MODULE_ID);return addPublisher(DEFAULT_EVENT,"Cross-frame Message Publisher")}();Y.CrossFrame={SUCCESS_MESSAGE:SUCCESS_MESSAGE,addPublisher:addPublisher,appendFrame:appendFrame,messageReceiveAdapter:messageReceiveAdapter,messageReceiveEvent:messageReceiveEvent,postMessage:postMessage,set:set,setOpener:setOpener};_init()},"3.2.0",{group:"mui",js:"crossframe/crossframe.js",requires:["node-base","event-custom","querystring-parse","json-stringify"]});YUI().use("node","crossframe","json-stringify",function(Y){"use strict";var body=Y.one("body"),topOffsetHeight=Y.one(".home-menu").get("offsetHeight"),iframe=Y.one("iframe"),match=location.pathname.match(/\/book\/(.*)\/(.*)/),viewport=Y.DOM.viewportRegion(),src;iframe.setStyles({top:topOffsetHeight,visibility:"hidden",height:viewport.height-topOffsetHeight});if(match&&match[2]){src=body.getAttribute("data-sourceUrl")+"/books/"+match[2]+"/1"}iframe.set("src",src);Y.Global.on("crossframe:message",function(e,data,callback){Y.log("Tenemos msg");Y.log(data.message)});iframe.on("load",function(){var frameName='frames["book"]',message=body.getAttribute("data-app")+"/css/book.css",config={eventType:"crossframe:css",callback:function(o){iframe.setStyles({visibility:"visible"})}};Y.CrossFrame.postMessage(frameName,message,config)})});